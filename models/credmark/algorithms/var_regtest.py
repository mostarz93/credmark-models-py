import credmark.model
from credmark.model import ModelRunError
from credmark.dto import EmptyInput

import numpy as np


@credmark.model.describe(slug='finance.var-regtest',
                         version='1.0',
                         display_name='Value at Risk - Regression Test',
                         description='Value at Risk - Regression Test',
                         input=EmptyInput,
                         output=None)
class ValueAtRiskRegressionTest(credmark.model.Model):
    def compare_dict(self, key_path, dict_a, dict_b):
        for k_a, v in dict_a.items():
            if k_a in dict_b:
                k_b = k_a
            else:
                k_b = str(k_a)
                assert k_b in dict_b
            new_key_path = key_path + [k_b]
            try:
                if isinstance(v, dict):
                    assert self.compare_dict(new_key_path, v, dict_b[k_b])
                elif isinstance(v, str):
                    assert v == dict_b[k_b]
                elif isinstance(v, float):
                    assert np.isclose(v, dict_b[k_b])
                else:
                    raise ModelRunError('')
            except:  # AssertionError as _err:
                print(f'Unequal value {dict_a[k_a]} != {dict_b[k_b]} at {new_key_path}')
                raise
        return True

    def run(self, input: EmptyInput) -> None:
        # AAVE
        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "AAVE"}}]}, "window": "39 days", "intervals": [
            "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True},)
        assert self.compare_dict([], res, {"window": "39 days", "var": {"2022-02-17": {"1 day": {"0.0": -27.890918649312358, "0.01": -23.746769030813933, "0.05": -12.875437236280206, "1.0": 15.707016513124435}, "2 day": {"0.0": -32.79411676105011, "0.01": -31.173347272577374, "0.05": -24.67226294937856, "1.0": 19.135472666345287}, "5 day": {"0.0": -42.59195297168045, "0.01": -41.26156958340214, "0.05": -34.75036257675467, "1.0": 25.167474866209282}, "10 day": {"0.0": -36.869725268669725, "0.01": -36.54175562443206, "0.05": -34.73545364941633, "1.0": 26.143982939435332}, "12 days": {"0.0": -37.61302188103508, "0.01": -36.766791582235136, "0.05": -32.77219603932363, "1.0": 27.899030282872523}}, "2022-02-16": {"1 day": {"0.0": -27.890918649312358, "0.01": -23.746769030813933, "0.05": -12.875437236280206, "1.0": 15.707016513124435}, "2 day": {"0.0": -32.79411676105011, "0.01": -31.173347272577374, "0.05": -24.67226294937856, "1.0": 19.135472666345287}, "5 day": {"0.0": -42.59195297168045, "0.01": -41.26156958340214, "0.05": -34.75036257675467, "1.0": 25.167474866209282}, "10 day": {"0.0": -36.869725268669725, "0.01": -36.54175562443206, "0.05": -34.73545364941633, "1.0": 26.143982939435332}, "12 days": {"0.0": -37.61302188103508, "0.01": -36.766791582235136, "0.05": -32.77219603932363, "1.0": 27.899030282872523}}, "2022-02-15": {"1 day": {"0.0": -27.890918649312358, "0.01": -23.746769030813933, "0.05": -12.875437236280206, "1.0": 15.707016513124435}, "2 day": {"0.0": -32.79411676105011, "0.01": -31.173347272577374, "0.05": -24.67226294937856, "1.0": 19.135472666345287}, "5 day": {"0.0": -42.59195297168045, "0.01": -41.26156958340214, "0.05": -34.75036257675467, "1.0": 25.167474866209282}, "10 day": {"0.0": -36.869725268669725, "0.01": -36.54175562443206, "0.05": -34.73545364941633, "1.0": 26.143982939435332}, "12 days": {"0.0": -37.61302188103508, "0.01": -36.766791582235136, "0.05": -32.77219603932363, "1.0": 27.899030282872523}}, "2022-02-14": {"1 day": {"0.0": -26.823391894384944, "0.01": -22.837859876468077, "0.05": -12.382629024978902, "1.0": 15.105829417830947}, "2 day": {"0.0": -31.53891977428834, "0.01": -29.98018534512181, "0.05": -23.727930454123317, "1.0": 18.403061185161985}, "5 day": {"0.0": -40.961743156307435, "0.01": -39.6822802801555, "0.05": -33.42029015208649, "1.0": 24.204188102103213}, "10 day": {"0.0": -35.45853409687594, "0.01": -35.143117512450665, "0.05": -33.405951864927516, "1.0": 25.143320264278117}, "12 days": {"0.0": -36.17338098227017, "0.01": -35.35954020409368, "0.05": -31.517838069634927, "1.0": 26.8311930546344}}, "2022-02-13": {"1 day": {"0.0": -26.63404040252063, "0.01": -22.676643023072934, "0.05": -12.295217660737048, "1.0": 14.999194457294395}, "2 day": {"0.0": -31.31628046250538, "0.01": -29.768549440020042, "0.05": -23.560430421016715, "1.0": 18.273150430250702}, "5 day": {"0.0": -36.93602484458391, "0.01": -35.11379243530006, "0.05": -30.22238175720166, "1.0": 24.033326074491516}, "10 day": {"0.0": -35.20822547233652, "0.01": -34.89503547435695, "0.05": -33.1701328138665, "1.0": 24.96582872177637}, "12 days": {"0.0": -35.91802611582604, "0.01": -35.109930396518116, "0.05": -31.29534757766726, "1.0": 26.641786492876715}}, "2022-02-12": {"1 day": {"0.0": -28.21750513106824, "0.01": -24.024829923979752, "0.05": -10.345308889919213, "1.0": 15.890936567045975}, "2 day": {"0.0": -33.17811684903384, "0.01": -31.53836908983316, "0.05": -24.961160839580977, "1.0": 19.359537953452335}, "5 day": {"0.0": -33.45382594621825, "0.01": -32.756999347342806, "0.05": -30.597642548427956, "1.0": 25.462171400754496}, "10 day": {"0.0": -37.30144836858625, "0.01": -36.96963839002395, "0.05": -35.14218566646436, "1.0": 26.45011381718204}, "12 days": {"0.0": -38.05344855319983, "0.01": -37.19730938838097, "0.05": -33.1559394483691, "1.0": 28.225711747152967}}, "2022-02-11": {"1 day": {"0.0": -28.293975576072278, "0.01": -24.0899380696822, "0.05": -10.373345045874236, "1.0": 15.934001571736093}, "2 day": {"0.0": -33.268030728664826, "0.01": -29.97169632445828, "0.05": -21.995319653907274, "1.0": 19.412002991573054}, "5 day": {
            "0.0": -33.54448700733305, "0.01": -32.845771983529204, "0.05": -30.680563250697148, "1.0": 25.531174793107596}, "10 day": {"0.0": -37.40253662365314, "0.01": -37.06982742821821, "0.05": -35.23742224261971, "1.0": 26.521794568708874}, "12 days": {"0.0": -38.15657475557969, "0.01": -37.29811542309842, "0.05": -33.245793226453536, "1.0": 28.302204432379202}}, "2022-02-10": {"1 day": {"0.0": -19.71545410437541, "0.01": -16.402600043526462, "0.05": -9.050579622329597, "1.0": 18.231745120189792}, "2 day": {"0.0": -27.87168186241622, "0.01": -26.69440560252552, "0.05": -18.35727675682906, "1.0": 22.211287555192627}, "5 day": {"0.0": -38.38172944516535, "0.01": -37.58225706101326, "0.05": -35.10481700483645, "1.0": 29.212867172840106}, "10 day": {"0.0": -42.79612447011389, "0.01": -42.41543734497435, "0.05": -40.318792371623445, "1.0": 30.346338082734984}, "12 days": {"0.0": -43.65889776471266, "0.01": -42.67664533581815, "0.05": -38.03996288656021, "1.0": 32.38348981124285}}, "2022-02-09": {"1 day": {"0.0": -20.228258593979557, "0.01": -16.829236270060793, "0.05": -9.285987736151352, "1.0": 18.705957923073033}, "2 day": {"0.0": -28.596632123069536, "0.01": -27.388734577542696, "0.05": -18.834754672781223, "1.0": 22.789009372701443}, "5 day": {"0.0": -39.38004899053582, "0.01": -38.55978210549436, "0.05": -36.01790313876511, "1.0": 29.97270203949516}, "10 day": {"0.0": -43.90926366791008, "0.01": -43.51867476389837, "0.05": -41.36749546687689, "1.0": 31.135654845589464}, "12 days": {"0.0": -44.79447793782895, "0.01": -43.78667684782854, "0.05": -39.029392987907656, "1.0": 33.22579346178722}}, "2022-02-08": {"1 day": {"0.0": -19.655115827577035, "0.01": -16.352400610310276, "0.05": -9.022880723001853, "1.0": 18.17594766922794}, "2 day": {"0.0": -27.78638181068282, "0.01": -26.612708552805735, "0.05": -18.301095121835818, "1.0": 22.143310890315497}, "5 day": {"0.0": -38.264263856850604, "0.01": -37.467238222631444, "0.05": -34.99738026236121, "1.0": 29.123462482680935}, "10 day": {"0.0": -42.66514882073219, "0.01": -42.285626771730826, "0.05": -40.19539848774859, "1.0": 25.26513105103519}, "12 days": {"0.0": -43.525281635756514, "0.01": -42.546035347051664, "0.05": -37.92354325970821, "1.0": 29.52131889321749}}, "2022-02-07": {"1 day": {"0.0": -19.72325874499179, "0.01": -16.409093244131235, "0.05": -9.054162421941934, "1.0": 18.238962413675356}, "2 day": {"0.0": -27.882715260843593, "0.01": -26.70497295953858, "0.05": -18.364543743783752, "1.0": 22.220080206687108}, "5 day": {"0.0": -38.39692339418466, "0.01": -37.59713452761182, "0.05": -35.11871374184164, "1.0": 29.22443149839157}, "10 day": {"0.0": -42.813065919673946, "0.01": -42.43222809416589, "0.05": -40.33475313432669, "1.0": 25.352723500440554}, "12 days": {"0.0": -43.6761807552518, "0.01": -42.69353948787751, "0.05": -38.05502154246629, "1.0": 28.82967318070566}}, "2022-02-06": {"1 day": {"0.0": -19.362214892869087, "0.01": -16.108716804755765, "0.05": -8.888421571465457, "1.0": 17.905089328416224}, "2 day": {"0.0": -27.372308585376153, "0.01": -26.216125430192413, "0.05": -18.028371831147098, "1.0": 21.813330822317003}, "5 day": {"0.0": -37.69404902077937, "0.01": -36.908900678726624, "0.05": -34.47584859187403, "1.0": 28.68946405408146}, "10 day": {"0.0": -42.02935190767036, "0.01": -41.65548550394068, "0.05": -39.596405844240394, "1.0": 24.888629555684844}, "12 days": {"0.0": -42.87666700603996, "0.01": -41.91201346539047, "0.05": -37.35840584888608, "1.0": 22.089263336807676}}, "2022-02-05": {"1 day": {"0.0": -19.196342557259296, "0.01": -15.970716555566009, "0.05": -8.978180077005218, "1.0": 17.75169990460087}, "2 day": {"0.0": -27.13781533234649, "0.01": -25.99153697376811, "0.05": -17.87392627006744, "1.0": 21.62646025244954}, "5 day": {"0.0": -37.37113142151394, "0.01": -36.592709292862764, "0.05": -34.180500690835615, "1.0": 28.44368698589097}, "10 day": {"0.0": -41.669294610317536, "0.01": -41.29863104747852, "0.05": -39.25719112343094, "1.0": 20.62797347223039}, "12 days": {"0.0": -42.509350924754536, "0.01": -41.55296138369018, "0.05": -37.03836363950562, "1.0": 19.920440797034278}}}})

        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "AAVE"}}]}, "window": "90 days", "intervals": [
            "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True})
        assert self.compare_dict([], res, {"window": "90 days", "var": {"2022-02-17": {"1 day": {"0.0": -38.814577969864594, "0.01": -29.0925211745731, "0.05": -14.930349497403622, "1.0": 54.45706888367619}, "2 day": {"0.0": -39.92919861726924, "0.01": -36.434112747762946, "0.05": -22.915533111726408, "1.0": 55.20332722584347}, "5 day": {"0.0": -42.59195297168045, "0.01": -39.26599450098468, "0.05": -33.1252258417513, "1.0": 70.22173144945148}, "10 day": {"0.0": -46.99300028564643, "0.01": -44.78895427504251, "0.05": -36.869725268669725, "1.0": 67.50058936653161}, "12 days": {"0.0": -53.94328750448398, "0.01": -51.075248350680475, "0.05": -36.67423439759306, "1.0": 69.49822045541872}}, "2022-02-16": {"1 day": {"0.0": -38.814577969864594, "0.01": -29.0925211745731, "0.05": -14.930349497403622, "1.0": 54.45706888367619}, "2 day": {"0.0": -39.92919861726924, "0.01": -36.434112747762946, "0.05": -22.915533111726408, "1.0": 55.20332722584347}, "5 day": {"0.0": -42.59195297168045, "0.01": -39.26599450098468, "0.05": -33.1252258417513, "1.0": 70.22173144945148}, "10 day": {"0.0": -46.99300028564643, "0.01": -44.78895427504251, "0.05": -36.869725268669725, "1.0": 67.50058936653161}, "12 days": {"0.0": -53.94328750448398, "0.01": -51.075248350680475, "0.05": -36.67423439759306, "1.0": 69.49822045541872}}, "2022-02-15": {"1 day": {"0.0": -38.814577969864594, "0.01": -29.0925211745731, "0.05": -14.930349497403622, "1.0": 54.45706888367619}, "2 day": {"0.0": -39.92919861726924, "0.01": -36.434112747762946, "0.05": -22.915533111726408, "1.0": 55.20332722584347}, "5 day": {"0.0": -42.59195297168045, "0.01": -39.26599450098468, "0.05": -33.1252258417513, "1.0": 70.22173144945148}, "10 day": {"0.0": -46.99300028564643, "0.01": -44.78895427504251, "0.05": -36.869725268669725, "1.0": 67.50058936653161}, "12 days": {"0.0": -53.94328750448398, "0.01": -51.075248350680475, "0.05": -36.67423439759306, "1.0": 69.49822045541872}}, "2022-02-14": {"1 day": {"0.0": -37.32894743237535, "0.01": -27.97900300356389, "0.05": -14.358889383475518, "1.0": 52.37272097247238}, "2 day": {"0.0": -38.40090590082275, "0.01": -35.03959467400141, "0.05": -22.038439567129366, "1.0": 53.09041622726459}, "5 day": {"0.0": -40.961743156307435, "0.01": -37.763085965927615, "0.05": -31.857355633038956, "1.0": 67.5339900364785}, "10 day": {"0.0": -45.19434009341658, "0.01": -43.07465408955875, "0.05": -35.45853409687594, "1.0": 64.91699984665331}, "12 days": {"0.0": -51.87860460953035, "0.01": -49.12033984391969, "0.05": -35.27052565181192, "1.0": 66.83817147356731}}, "2022-02-13": {"1 day": {"0.0": -37.065435199698896, "0.01": -27.781493830210238, "0.05": -14.257527216566084, "1.0": 52.003011843657575}, "2 day": {"0.0": -38.12982650676655, "0.01": -34.79224342357166, "0.05": -21.882865975734646, "1.0": 52.71564074935665}, "5 day": {"0.0": -36.93602484458391, "0.01": -36.57905874898943, "0.05": -31.092897758007346, "1.0": 67.05725458798237}, "10 day": {"0.0": -44.87530453839779, "0.01": -42.7705818064742, "0.05": -35.20822547233652, "1.0": 64.45873823616353}, "12 days": {"0.0": -51.51238354333067, "0.01": -48.77358990017841, "0.05": -35.98228614288233, "1.0": 66.36634794238101}}, "2022-02-12": {"1 day": {"0.0": -39.26907416697461, "0.01": -29.43317772501794, "0.05": -13.912513461356493, "1.0": 55.09472957736209}, "2 day": {"0.0": -40.39674637572457, "0.01": -36.860735077697655, "0.05": -23.18386071436361, "1.0": 55.84972617191588}, "5 day": {"0.0": -38.687042160058276, "0.01": -36.62152734755254, "0.05": -31.302000266984052, "1.0": 71.04398719890304}, "10 day": {"0.0": -47.5432610649134, "0.01": -45.31340695378465, "0.05": -37.30144836858625, "1.0": 68.29098212034675}, "12 days": {"0.0": -54.57493211619238, "0.01": -51.67330988724689, "0.05": -38.9459650849557, "1.0": 70.31200431073785}}, "2022-02-11": {"1 day": {"0.0": -39.375494758111095, "0.01": -29.51294268609655, "0.05": -13.950216868889258, "1.0": 55.24403825892654}, "2 day": {"0.0": -40.50622299875406, "0.01": -36.96062898403255, "0.05": -20.3875791648134, "1.0": 56.00108092117108},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "5 day": {"0.0": -38.79188542370358,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "0.01": -36.720772992409756, "0.05": -31.386829803784494, "1.0": 71.23651893729473}, "10 day": {"0.0": -47.67210499756052, "0.01": -45.43620790228487, "0.05": -37.40253662365314, "1.0": 68.4760531168168}, "12 days": {"0.0": -54.72283212810361, "0.01": -51.81334639945996, "0.05": -39.05151003895942, "1.0": 70.50255234940367}}, "2022-02-10": {"1 day": {"0.0": -45.05359066140932, "0.01": -24.023825867420413, "0.05": -11.20464937140413, "1.0": 63.210438408223574}, "2 day": {"0.0": -46.34737420917616, "0.01": -42.29049207037078, "0.05": -20.446257685838738, "1.0": 64.07664949782425}, "5 day": {"0.0": -44.385822644268224, "0.01": -42.01604793371561, "0.05": -35.91292987747756, "1.0": 81.50909554434187}, "10 day": {"0.0": -54.54660361024123, "0.01": -51.98828166126223, "0.05": -43.118571766468605, "1.0": 78.3505600675272}, "12 days": {"0.0": -62.61407237364884, "0.01": -59.28502775189152, "0.05": -44.682886115171094, "1.0": 80.66928818666585}}, "2022-02-09": {"1 day": {"0.0": -46.2254471878502, "0.01": -24.64869231467852, "0.05": -11.49608544341533, "1.0": 64.85455963586446}, "2 day": {"0.0": -47.55288240848029, "0.01": -43.39047962766685, "0.05": -20.97807058151911, "1.0": 65.74330111879722}, "5 day": {"0.0": -45.54031033733651, "0.01": -43.108897122061244, "0.05": -36.84703525382403, "1.0": 83.6291699751629}, "10 day": {"0.0": -55.965376065387545, "0.01": -53.34051144514448, "0.05": -44.24009790885943, "1.0": 80.38848010492113}, "12 days": {"0.0": -64.24268195350528, "0.01": -60.82704794764898, "0.05": -45.8451005124162, "1.0": 82.76751899262594}}, "2022-02-08": {"1 day": {"0.0": -44.91570613642211, "0.01": -23.950302009066945, "0.05": -11.170358036717069, "1.0": 63.01698565237883}, "2 day": {"0.0": -46.20553011676489, "0.01": -42.16106388662354, "0.05": -20.383682816946155, "1.0": 63.88054574118523}, "5 day": {"0.0": -44.249981793813795, "0.01": -41.88745967413118, "0.05": -35.80301994123586, "1.0": 81.25964055626487}, "10 day": {"0.0": -54.37966613826509, "0.01": -51.82917382065444, "0.05": -42.986609281373305, "1.0": 78.11077163781951}, "12 days": {"0.0": -62.42244476972181, "0.01": -59.10358854204348, "0.05": -46.99031818721431, "1.0": 80.42240339192736}}, "2022-02-07": {"1 day": {"0.0": -45.07142576080536, "0.01": -24.03333603777373, "0.05": -11.209084889912269, "1.0": 63.23546115192342}, "2 day": {"0.0": -46.36572147103989, "0.01": -42.307233358212876, "0.05": -20.45435162536166, "1.0": 64.10201514340281}, "5 day": {"0.0": -44.40339339827504, "0.01": -42.03268057897486, "0.05": -35.927146517362736, "1.0": 81.54136206959265}, "10 day": {"0.0": -54.568196652722925, "0.01": -52.00886195591235, "0.05": -48.19160600257036, "1.0": 78.3815762419547}, "12 days": {"0.0": -62.63885903744146, "0.01": -59.30849656641061, "0.05": -49.57235521060426, "1.0": 80.70122226232765}}, "2022-02-06": {"1 day": {"0.0": -44.24637137259603, "0.01": -23.593394122767396, "0.05": -11.003897134696516, "1.0": 62.07790525407549}, "2 day": {"0.0": -45.51697436982351, "0.01": -41.532778857473645, "0.05": -20.07992476218582, "1.0": 62.928596552923764}, "5 day": {"0.0": -43.5905676676435, "0.01": -41.263251900505104, "0.05": -35.2694826119141, "1.0": 80.04870774458598}, "10 day": {"0.0": -53.56929925054334, "0.01": -51.05681442117884, "0.05": -47.30943519620878, "1.0": 76.94676333462871}, "12 days": {"0.0": -61.49222423171032, "0.01": -58.22282566684996, "0.05": -48.66490911787497, "1.0": 79.2239471054523}}, "2022-02-05": {"1 day": {"0.0": -43.867321299944805, "0.01": -23.391274096222965, "0.05": -10.909628884465796, "1.0": 61.54609589284126}, "2 day": {"0.0": -45.127039287995956, "0.01": -41.17697560502698, "0.05": -19.9079039454765, "1.0": 62.38949948450295}, "5 day": {"0.0": -43.217135738001424, "0.01": -40.9097576331673, "0.05": -34.96733580231838, "1.0": 79.36294600763563}, "10 day": {"0.0": -53.110381464906126, "0.01": -50.61942060524947, "0.05": -46.904144450506685, "1.0": 76.28757535316336}, "12 days": {"0.0": -60.96543228607856, "0.01": -57.724042023935276, "0.05": -48.248006290265465, "1.0": 78.54525093276145}}}})
        # AAVE+WETH
        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "WETH"}}, {"amount":  1, "token": {"symbol": "AAVE"}}]}, "window": "90 days", "intervals": [
                                     "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True})

        assert self.compare_dict([], res, {"window": "90 days", "var": {"2022-02-17": {"1 day": {"0.0": -503.36361135397516, "0.01": -348.4810597821483, "0.05": -211.4115079364923, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -587.3164422415356, "0.05": -341.76986142847386, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -784.9559429472309, "0.05": -609.4670255115867, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -880.7135579051808, "0.05": -808.8750794436386, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -890.8498905406999, "0.05": -795.8949382349053, "1.0": 935.338611763215}}, "2022-02-16": {"1 day": {"0.0": -503.36361135397516, "0.01": -348.4810597821483, "0.05": -211.4115079364923, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -587.3164422415356, "0.05": -341.76986142847386, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -784.9559429472309, "0.05": -609.4670255115867, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -880.7135579051808, "0.05": -808.8750794436386, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -890.8498905406999, "0.05": -795.8949382349053, "1.0": 935.338611763215}}, "2022-02-15": {"1 day": {"0.0": -503.36361135397516, "0.01": -348.4810597821483, "0.05": -211.4115079364923, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -587.3164422415356, "0.05": -341.76986142847386, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -784.9559429472309, "0.05": -609.4670255115867, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -880.7135579051808, "0.05": -808.8750794436386, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -890.8498905406999, "0.05": -795.8949382349053, "1.0": 935.338611763215}}, "2022-02-14": {"1 day": {"0.0": -466.6896887856285, "0.01": -323.3216872914743, "0.05": -196.01676073213338, "1.0": 329.41640220325445}, "2 day": {"0.0": -612.893693647647, "0.01": -544.5896732730951, "0.05": -317.3733940665879, "1.0": 375.5953909236079}, "5 day": {"0.0": -758.5922059908401, "0.01": -727.9396999514497, "0.05": -565.1539449648649, "1.0": 530.9420707494363}, "10 day": {"0.0": -847.0260541253795, "0.01": -816.7156504065144, "0.05": -750.1647210544672, "1.0": 784.5724894767546}, "12 days": {"0.0": -833.6920995071631, "0.01": -825.8187731794447, "0.05": -738.1277477143866, "1.0": 866.9754342607475}}, "2022-02-13": {"1 day": {"0.0": -458.9476315049229, "0.01": -318.01900443921994, "0.05": -197.3879668676259, "1.0": 323.9290753441964}, "2 day": {"0.0": -602.7424133651582, "0.01": -535.572208915403, "0.05": -312.24199151510027, "1.0": 369.3393926825725}, "5 day": {"0.0": -746.0595234295173, "0.01": -715.9097626311685, "0.05": -555.8026296630916, "1.0": 522.1122340519148}, "10 day": {"0.0": -832.9163249093508, "0.01": -803.2116610683267, "0.05": -737.7789606542349, "1.0": 771.4931389659054}, "12 days": {"0.0": -819.930782510428, "0.01": -812.0856658681369, "0.05": -725.941000335376, "1.0": 852.5355250015331}}, "2022-02-12": {"1 day": {"0.0": -464.41341488599886, "0.01": -322.108575034837, "0.05": -199.74548285364193, "1.0": 327.6752288162599}, "2 day": {"0.0": -610.0009497640722, "0.01": -542.034255781075, "0.05": -316.62239867858597, "1.0": 373.61350517708286}, "5 day": {"0.0": -755.2013956387942, "0.01": -724.6640448370155, "0.05": -562.5417493897733, "1.0": 528.221900117143}, "10 day": {"0.0": -842.5477665016326, "0.01": -812.9991126607055, "0.05": -746.8574660047786, "1.0": 780.3649199284483}, "12 days": {"0.0": -830.0377183600244, "0.01": -821.5919135916479, "0.05": -734.875194140918, "1.0": 862.4044150376145}}, "2022-02-11": {"1 day": {"0.0": -466.48009216852944, "0.01": -323.5302679671243, "0.05": -200.63410480359343, "1.0": 329.1377390392359}, "2 day": {"0.0": -612.7123918203985, "0.01": -544.4431061463454, "0.05": -318.0057327121187, "1.0": 375.2809427025796}, "5 day": {
            "0.0": -758.5521469517013, "0.01": -727.8800085247187, "0.05": -565.0404583896066, "1.0": 530.5767323341476}, "10 day": {"0.0": -846.3083425214342, "0.01": -816.6084282319673, "0.05": -750.1697193510603, "1.0": 783.8498687034189}, "12 days": {"0.0": -833.7181897534241, "0.01": -825.2544694358666, "0.05": -738.1342544796786, "1.0": 866.2532075654218}}, "2022-02-10": {"1 day": {"0.0": -493.9860425986128, "0.01": -343.1826936790369, "0.05": -212.47732440642017, "1.0": 348.33267731054667}, "2 day": {"0.0": -648.9937514885385, "0.01": -576.7055761837061, "0.05": -326.05046246270854, "1.0": 397.1722362550529}, "5 day": {"0.0": -803.7691291078997, "0.01": -771.2340823848651, "0.05": -598.586283649076, "1.0": 561.6557344573919}, "10 day": {"0.0": -895.6621500674676, "0.01": -865.1819034685878, "0.05": -794.9595690836, "1.0": 829.4672072265969}, "12 days": {"0.0": -883.5297976410106, "0.01": -873.600888022504, "0.05": -782.208094334783, "1.0": 916.7902916516903}}, "2022-02-09": {"1 day": {"0.0": -518.5677471681513, "0.01": -360.0766449944284, "0.05": -223.0465115213479, "1.0": 365.73418194453797}, "2 day": {"0.0": -681.2402116086521, "0.01": -605.3527315150144, "0.05": -342.16292213896963, "1.0": 417.0118952029101}, "5 day": {"0.0": -843.6103229360953, "0.01": -809.4735907929443, "0.05": -628.3003189524567, "1.0": 589.6706208642008}, "10 day": {"0.0": -940.4069722542163, "0.01": -908.1004107119136, "0.05": -834.3409769363304, "1.0": 870.9351335280918}, "12 days": {"0.0": -927.2882375477383, "0.01": -917.1732765989968, "0.05": -820.9569854097166, "1.0": 962.5841861585882}}, "2022-02-08": {"1 day": {"0.0": -498.607323965012, "0.01": -346.2972846448805, "0.05": -214.46292617722102, "1.0": 351.62679672863555}, "2 day": {"0.0": -655.0396713617371, "0.01": -582.0741337936893, "0.05": -329.04191495392865, "1.0": 400.9273327208037}, "5 day": {"0.0": -811.2069553125957, "0.01": -778.3765949029072, "0.05": -604.1480651865282, "1.0": 566.9444701561952}, "10 day": {"0.0": -904.1325878901354, "0.01": -873.2053825318376, "0.05": -802.3037921334346, "1.0": 837.3273206391723}, "12 days": {"0.0": -891.6867148025426, "0.01": -881.825934028658, "0.05": -789.4340828688682, "1.0": 925.4571801423456}}, "2022-02-07": {"1 day": {"0.0": -505.5718898680789, "0.01": -351.05350351934777, "0.05": -217.4567465563685, "1.0": 356.56821463955725}, "2 day": {"0.0": -664.16781201602, "0.01": -590.1821613237651, "0.05": -333.588422962345, "1.0": 406.56082170565793}, "5 day": {"0.0": -822.4692007530347, "0.01": -789.1878994679922, "0.05": -612.5547489045705, "1.0": 574.8925773238805}, "10 day": {"0.0": -916.8386515421575, "0.01": -885.34301028544, "0.05": -813.4322431459474, "1.0": 849.1077798400089}, "12 days": {"0.0": -904.0502729386485, "0.01": -894.187526351326, "0.05": -800.3836602489903, "1.0": 926.7063128143113}}, "2022-02-06": {"1 day": {"0.0": -488.30152404911354, "0.01": -339.18402285519363, "0.05": -210.03114710552134, "1.0": 344.3425516413228}, "2 day": {"0.0": -641.5123402430836, "0.01": -570.0554493417578, "0.05": -322.2681105353483, "1.0": 392.62219757692634}, "5 day": {"0.0": -794.4777230290572, "0.01": -762.3217459339935, "0.05": -591.6784434106855, "1.0": 477.28378925024145}, "10 day": {"0.0": -885.402571095322, "0.01": -855.189539461111, "0.05": -785.7637623401494, "1.0": 819.9739756662424}, "12 days": {"0.0": -873.306571628325, "0.01": -863.5750409085947, "0.05": -773.1595699879681, "1.0": 769.9624778244171}}, "2022-02-05": {"1 day": {"0.0": -482.30204656288527, "0.01": -335.04488542576166, "0.05": -207.45124639747402, "1.0": 340.10138785195585}, "2 day": {"0.0": -633.6379448067082, "0.01": -563.0593269812259, "0.05": -318.3258830361003, "1.0": 387.78664969700145}, "5 day": {"0.0": -784.7404162915851, "0.01": -752.9768569809677, "0.05": -584.4200272099513, "1.0": 471.4057466333192}, "10 day": {"0.0": -874.497238777006, "0.01": -844.7030267968511, "0.05": -776.1368110637399, "1.0": 695.373627299745}, "12 days": {"0.0": -862.6087072772674, "0.01": -852.9493675986514, "0.05": -763.6871682267031, "1.0": 733.6756701710589}}}})

        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "WETH"}}, {"amount":  1, "token": {"symbol": "AAVE"}}]}, "window": "39 days", "intervals": [
            "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True})

        assert self.compare_dict([], res, {"window": "39 days", "var": {"2022-02-17": {"1 day": {"0.0": -503.36361135397516, "0.01": -386.12213411038624, "0.05": -186.49068865467524, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -630.0141115566435, "0.05": -379.42063260133983, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -804.7786466768887, "0.05": -726.2859949190122, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -901.821889370771, "0.05": -870.6323425136768, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -896.1298848020447, "0.05": -866.498147507959, "1.0": 935.338611763215}}, "2022-02-16": {"1 day": {"0.0": -503.36361135397516, "0.01": -386.12213411038624, "0.05": -186.49068865467524, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -630.0141115566435, "0.05": -379.42063260133983, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -804.7786466768887, "0.05": -726.2859949190122, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -901.821889370771, "0.05": -870.6323425136768, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -896.1298848020447, "0.05": -866.498147507959, "1.0": 935.338611763215}}, "2022-02-15": {"1 day": {"0.0": -503.36361135397516, "0.01": -386.12213411038624, "0.05": -186.49068865467524, "1.0": 355.3946869900525}, "2 day": {"0.0": -660.9908520401531, "0.01": -630.0141115566435, "0.05": -379.42063260133983, "1.0": 405.21312096526407}, "5 day": {"0.0": -817.9937824966605, "0.01": -804.7786466768887, "0.05": -726.2859949190122, "1.0": 572.7541780355135}, "10 day": {"0.0": -913.8246660864988, "0.01": -901.821889370771, "0.05": -870.6323425136768, "1.0": 846.4864327560342}, "12 days": {"0.0": -898.9251758815801, "0.01": -896.1298848020447, "0.05": -866.498147507959, "1.0": 935.338611763215}}, "2022-02-14": {"1 day": {"0.0": -466.6896887856285, "0.01": -365.2851608765884, "0.05": -183.24466286710603, "1.0": 329.41640220325445}, "2 day": {"0.0": -612.893693647647, "0.01": -584.1749578083467, "0.05": -352.4305380732835, "1.0": 375.5953909236079}, "5 day": {"0.0": -758.5922059908401, "0.01": -746.3312035750839, "0.05": -673.5003204090276, "1.0": 530.9420707494363}, "10 day": {"0.0": -847.0260541253795, "0.01": -836.0385327772908, "0.05": -807.4499691625788, "1.0": 784.5724894767546}, "12 days": {"0.0": -833.6920995071631, "0.01": -830.9667173167991, "0.05": -803.1579466833437, "1.0": 866.9754342607475}}, "2022-02-13": {"1 day": {"0.0": -458.9476315049229, "0.01": -359.2252017709413, "0.05": -180.38670330614218, "1.0": 323.9290753441964}, "2 day": {"0.0": -602.7424133651582, "0.01": -574.5003955851475, "0.05": -352.3437379523418, "1.0": 369.3393926825725}, "5 day": {"0.0": -746.0595234295173, "0.01": -733.9996191101777, "0.05": -662.3618360077268, "1.0": 522.1122340519148}, "10 day": {"0.0": -832.9163249093508, "0.01": -822.1483842669795, "0.05": -794.121168797403, "1.0": 771.4931389659054}, "12 days": {"0.0": -819.930782510428, "0.01": -817.2151652111734, "0.05": -789.7786910537404, "1.0": 852.5355250015331}}, "2022-02-12": {"1 day": {"0.0": -464.41341488599886, "0.01": -363.5026966384461, "0.05": -185.9728884969149, "1.0": 327.6752288162599}, "2 day": {"0.0": -610.0009497640722, "0.01": -581.4240443394029, "0.05": -356.5832861423235, "1.0": 373.61350517708286}, "5 day": {"0.0": -755.2013956387942, "0.01": -742.9864553180827, "0.05": -670.4206446393811, "1.0": 528.221900117143}, "10 day": {"0.0": -842.5477665016326, "0.01": -831.8363794842965, "0.05": -803.9067489301648, "1.0": 780.3649199284483}, "12 days": {"0.0": -830.0377183600244, "0.01": -827.1141705555865, "0.05": -798.9099240505498, "1.0": 862.4044150376145}}, "2022-02-11": {"1 day": {"0.0": -466.48009216852944, "0.01": -365.12033848834164, "0.05": -186.79600599690065, "1.0": 329.1377390392359}, "2 day": {"0.0": -612.7123918203985, "0.01": -584.0082603438079, "0.05": -358.16842966743366, "1.0": 375.2809427025796},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "5 day": {"0.0": -758.5521469517013, "0.01": -746.2832915809082, "0.05": -673.3974600983383, "1.0": 530.5767323341476}, "10 day": {"0.0": -846.3083425214342, "0.01": -835.5421235915023, "0.05": -807.4714774368258, "1.0": 783.8498687034189}, "12 days": {"0.0": -833.7181897534241, "0.01": -830.7884404127312, "0.05": -802.4757833562396, "1.0": 866.2532075654218}}, "2022-02-10": {"1 day": {"0.0": -493.9860425986128, "0.01": -386.6483723843839, "0.05": -198.03031588120427, "1.0": 348.33267731054667}, "2 day": {"0.0": -648.9937514885385, "0.01": -618.5998595990067, "0.05": -379.3703616599921, "1.0": 397.1722362550529}, "5 day": {"0.0": -803.7691291078997, "0.01": -790.7551104186858, "0.05": -713.428983531346, "1.0": 561.6557344573919}, "10 day": {"0.0": -895.6621500674676, "0.01": -884.6130606753736, "0.05": -855.7088258875931, "1.0": 829.4672072265969}, "12 days": {"0.0": -883.5297976410106, "0.01": -880.0928673884507, "0.05": -849.2707856063225, "1.0": 916.7902916516903}}, "2022-02-09": {"1 day": {"0.0": -518.5677471681513, "0.01": -405.88914434574895, "0.05": -207.81457724946085, "1.0": 365.73418194453797}, "2 day": {"0.0": -681.2402116086521, "0.01": -649.3329756601908, "0.05": -398.22224238306853, "1.0": 417.0118952029101}, "5 day": {"0.0": -843.6103229360953, "0.01": -829.9556300788348, "0.05": -748.8270669554614, "1.0": 589.6706208642008}, "10 day": {"0.0": -940.4069722542163, "0.01": -928.6958436951315, "0.05": -898.0913290027672, "1.0": 870.9351335280918}, "12 days": {"0.0": -927.2882375477383, "0.01": -923.7869049116355, "0.05": -891.6988649314357, "1.0": 962.5841861585882}}, "2022-02-08": {"1 day": {"0.0": -498.607323965012, "0.01": -390.26570891361956, "0.05": -199.84625733219687, "1.0": 351.62679672863555}, "2 day": {"0.0": -655.0396713617371, "0.01": -624.360979429717, "0.05": -382.90564289919797, "1.0": 400.9273327208037}, "5 day": {"0.0": -811.2069553125957, "0.01": -798.0748111487203, "0.05": -720.0490557987174, "1.0": 566.9444701561952}, "10 day": {"0.0": -904.1325878901354, "0.01": -892.9214759477524, "0.05": -863.6099127764935, "1.0": 837.3273206391723}, "12 days": {"0.0": -891.6867148025426, "0.01": -888.2733676115826, "0.05": -857.3029322788248, "1.0": 925.4571801423456}}, "2022-02-07": {"1 day": {"0.0": -505.5718898680789, "0.01": -395.7171305929657, "0.05": -202.60681443546537, "1.0": 356.56821463955725}, "2 day": {"0.0": -664.16781201602, "0.01": -633.0602088840492, "0.05": -388.2424801293497, "1.0": 406.56082170565793}, "5 day": {"0.0": -822.4692007530347, "0.01": -809.1566802390175, "0.05": -730.0610963714955, "1.0": 574.8925773238805}, "10 day": {"0.0": -916.8386515421575, "0.01": -905.4214815865973, "0.05": -875.5850346638845, "1.0": 849.1077798400089}, "12 days": {"0.0": -904.0502729386485, "0.01": -900.6362452738061, "0.05": -869.3512550864837, "1.0": 926.7063128143113}}, "2022-02-06": {"1 day": {"0.0": -488.30152404911354, "0.01": -382.19914393245665, "0.05": -195.73257264893988, "1.0": 344.3425516413228}, "2 day": {"0.0": -641.5123402430836, "0.01": -611.4679656595716, "0.05": -374.9976732147392, "1.0": 392.62219757692634}, "5 day": {"0.0": -794.4777230290572, "0.01": -781.6153321910317, "0.05": -705.1912996453348, "1.0": 477.28378925024145}, "10 day": {"0.0": -885.402571095322, "0.01": -874.4503471279204, "0.05": -845.8080389618691, "1.0": 819.9739756662424}, "12 days": {"0.0": -873.306571628325, "0.01": -869.937964840726, "0.05": -839.5428350610005, "1.0": 769.9624778244171}}, "2022-02-05": {"1 day": {"0.0": -482.30204656288527, "0.01": -377.5032235722223, "0.05": -193.33850316825828, "1.0": 340.10138785195585}, "2 day": {"0.0": -633.6379448067082, "0.01": -603.9628441300849, "0.05": -370.39434314931657, "1.0": 387.78664969700145}, "5 day": {"0.0": -784.7404162915851, "0.01": -772.0349925673381, "0.05": -696.5429457809871, "1.0": 471.4057466333192}, "10 day": {"0.0": -874.497238777006, "0.01": -863.6968369341998, "0.05": -835.44672756407, "1.0": 695.373627299745}, "12 days": {"0.0": -862.6087072772674, "0.01": -859.265089696208, "0.05": -829.2022187013517, "1.0": 733.6756701710589}}}})
        # WETH
        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "WETH"}}]}, "window": "39 days", "intervals": [
            "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True})
        assert self.compare_dict([], res, {"window": "39 days", "var": {"2022-02-17": {"1 day": {"0.0": -486.3783495954481, "0.01": -369.17664938819144, "0.05": -168.04352276227905, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -607.0163421800526, "0.05": -348.3550121822815, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -772.4007734471822, "0.05": -698.1500937865275, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -873.5894417937418, "0.05": -834.2715356584794, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -864.1133623850204, "0.05": -840.6082966579372, "1.0": 909.8273233405478}}, "2022-02-16": {"1 day": {"0.0": -486.3783495954481, "0.01": -369.17664938819144, "0.05": -168.04352276227905, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -607.0163421800526, "0.05": -348.3550121822815, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -772.4007734471822, "0.05": -698.1500937865275, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -873.5894417937418, "0.05": -834.2715356584794, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -864.1133623850204, "0.05": -840.6082966579372, "1.0": 909.8273233405478}}, "2022-02-15": {"1 day": {"0.0": -486.3783495954481, "0.01": -369.17664938819144, "0.05": -168.04352276227905, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -607.0163421800526, "0.05": -348.3550121822815, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -772.4007734471822, "0.05": -698.1500937865275, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -873.5894417937418, "0.05": -834.2715356584794, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -864.1133623850204, "0.05": -840.6082966579372, "1.0": 909.8273233405478}}, "2022-02-14": {"1 day": {"0.0": -450.35453904365636, "0.01": -352.5127957472479, "0.05": -167.58303371977163, "1.0": 320.16825297384247}, "2 day": {"0.0": -589.8007385286403, "0.01": -562.0574295748266, "0.05": -322.55395632924143, "1.0": 364.9935482294101}, "5 day": {"0.0": -726.7911987949929, "0.01": -715.1925955834629, "0.05": -646.4413227522074, "1.0": 514.5731745792358}, "10 day": {"0.0": -823.2670768130922, "0.01": -808.8866839974729, "0.05": -772.4808745932594, "1.0": 763.5749180256539}, "12 days": {"0.0": -801.0717811887579, "0.01": -800.1124542695144, "0.05": -778.3483008084975, "1.0": 842.4405920887864}}, "2022-02-13": {"1 day": {"0.0": -442.7277947325278, "0.01": -346.54299922809986, "0.05": -164.74501869325934, "1.0": 314.7462105821802}, "2 day": {"0.0": -579.8124758660169, "0.01": -552.5389992451574, "0.05": -339.0118223220468, "1.0": 358.81239043877565}, "5 day": {"0.0": -714.4830056710623, "0.01": -703.0808245523315, "0.05": -635.4938530292455, "1.0": 505.85888907383065}, "10 day": {"0.0": -809.3250667959243, "0.01": -795.188205619469, "0.05": -759.39892780469, "1.0": 750.643793417608}, "12 days": {"0.0": -787.5056480196309, "0.01": -786.562567280873, "0.05": -765.1669892847508, "1.0": 828.173879007975}}, "2022-02-12": {"1 day": {"0.0": -447.2292655630582, "0.01": -350.0665033340308, "0.05": -176.6138838223971, "1.0": 317.94641825563707}, "2 day": {"0.0": -585.707766331946, "0.01": -558.1569844212072, "0.05": -342.45875257477604, "1.0": 362.4606445768942}, "5 day": {"0.0": -721.747569692576, "0.01": -710.22945597074, "0.05": -641.9552884223426, "1.0": 511.00225043632673}, "10 day": {"0.0": -817.553945181118, "0.01": -803.273346319841, "0.05": -767.1201781145201, "1.0": 758.276025187085}, "12 days": {"0.0": -795.5126756912955, "0.01": -794.5600061024883, "0.05": -772.9468868284121, "1.0": 836.5944042230542}}, "2022-02-11": {"1 day": {"0.0": -449.24937318822055, "0.01": -351.64773262100215, "0.05": -177.41163808601837, "1.0": 319.38256305511175}, "2 day": {"0.0": -588.3533729949946, "0.01": -560.6781458636437, "0.05": -344.00561811030605, "1.0": 364.09785745250775}, "5 day": {"0.0": -725.0076599443682,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "0.01": -713.437519597379, "0.05": -644.8549617510157, "1.0": 513.3104167887274}, "10 day": {"0.0": -821.246787053983, "0.01": -806.9016835887526, "0.05": -770.5852137026407, "1.0": 761.701112269724}, "12 days": {"0.0": -799.1059584789368, "0.01": -798.1489857390419, "0.05": -776.4382413084496, "1.0": 840.3732507012948}}, "2022-02-10": {"1 day": {"0.0": -474.2705884942374, "0.01": -371.23296557823636, "0.05": -187.29268647311002, "1.0": 337.170767896616}, "2 day": {"0.0": -621.1220696261222, "0.01": -591.9054539964811, "0.05": -363.16521888199406, "1.0": 384.37650763542473}, "5 day": {"0.0": -765.3873996627344, "0.01": -753.1728533576726, "0.05": -680.7705485099211, "1.0": 541.8995506280104}, "10 day": {"0.0": -866.9866231107894, "0.01": -851.8425604397992, "0.05": -813.5034228185579, "1.0": 804.124515987971}, "12 days": {"0.0": -843.6126477092976, "0.01": -842.6023757943877, "0.05": -819.6824383336603, "1.0": 887.1783467084175}}, "2022-02-09": {"1 day": {"0.0": -498.33948857417175, "0.01": -390.07277848598716, "0.05": -196.79765908955665, "1.0": 354.2819481368745}, "2 day": {"0.0": -652.6435794855826, "0.01": -621.9442410826481, "0.05": -381.5955992973809, "1.0": 403.8833460938748}, "5 day": {"0.0": -804.2302739455595, "0.01": -791.3958479733406, "0.05": -715.3191768814788, "1.0": 569.4005731536469}, "10 day": {"0.0": -910.9855868005794, "0.01": -895.0729735593554, "0.05": -854.78815156522, "1.0": 844.9332717840838}, "12 days": {"0.0": -886.4253985238689, "0.01": -885.3638560170999, "0.05": -861.2807477885372, "1.0": 932.2020262239473}}, "2022-02-08": {"1 day": {"0.0": -478.9522081374349, "0.01": -374.8974802793723, "0.05": -189.1414899648121, "1.0": 340.49904784563915}, "2 day": {"0.0": -627.2532895510543, "0.01": -597.7482708769112, "0.05": -366.75009524517316, "1.0": 388.1707648636515}, "5 day": {"0.0": -772.9426914557451, "0.01": -760.6075729260888, "0.05": -687.4905704757216, "1.0": 547.2487492551371}, "10 day": {"0.0": -875.5448211176099, "0.01": -860.251268381247, "0.05": -821.5336774800737, "1.0": 812.0621895881371}, "12 days": {"0.0": -851.9401165394961, "0.01": -850.9198720288643, "0.05": -827.7736872906542, "1.0": 895.935861249128}}, "2022-02-07": {"1 day": {"0.0": -485.84863112308716, "0.01": -380.2956213805819, "0.05": -191.86493438530331, "1.0": 345.40188662633346}, "2 day": {"0.0": -636.2850967551764, "0.01": -606.3552359245106, "0.05": -372.0309223169907, "1.0": 393.7600277163572}, "5 day": {"0.0": -784.07227735885, "0.01": -771.5595457114058, "0.05": -697.3897330478826, "1.0": 555.1285727304464}, "10 day": {"0.0": -888.1517729736323, "0.01": -872.6380086862391, "0.05": -833.3629239906886, "1.0": 823.7550563395683}, "12 days": {"0.0": -864.2071847402054, "0.01": -863.1722497498671, "0.05": -839.6927835740798, "1.0": 897.8766396336057}}, "2022-02-06": {"1 day": {"0.0": -468.93930915624446, "0.01": -367.0599329530156, "0.05": -185.18732794197814, "1.0": 333.380628697874}, "2 day": {"0.0": -614.1400316577075, "0.01": -585.2518402293792, "0.05": -359.0828758595218, "1.0": 380.0557283527104}, "5 day": {"0.0": -756.7836740082778, "0.01": -744.706431512305, "0.05": -673.118001530974, "1.0": 461.9559070294484}, "10 day": {"0.0": -857.2408198030581, "0.01": -842.2669916571888, "0.05": -804.3588245772274, "1.0": 795.0853461105576}, "12 days": {"0.0": -834.1295914390756, "0.01": -833.1306759985422, "0.05": -810.4683817313353, "1.0": 747.8732144876094}}, "2022-02-05": {"1 day": {"0.0": -463.10570400562597, "0.01": -362.4937072738053, "0.05": -182.8835975252311, "1.0": 329.23337357399106}, "2 day": {"0.0": -606.5001294743618, "0.01": -577.9713071563168, "0.05": -354.6158847730162, "1.0": 375.32783497471735}, "5 day": {"0.0": -747.3692848700712, "0.01": -735.4422832744754, "0.05": -664.7444133842043, "1.0": 456.2091754034423}, "10 day": {"0.0": -846.5767437401632, "0.01": -831.7891900210493, "0.05": -794.3526005512613, "1.0": 674.7456538275146}, "12 days": {"0.0": -823.7530190641609, "0.01": -822.7665301320159, "0.05": -800.3861548124867, "1.0": 713.7552293740246}}}},)

        res = self.context.run_model('finance.var', input={"portfolio": {"positions": [{"amount":  1, "token": {"symbol": "WETH"}}]}, "window": "90 days", "intervals": [
            "1 day", "2 day", "5 day", "10 day", "12 days"], "asOfs": ["2022-02-17", "2022-02-05"], "asOf_is_range": True, "confidences": [0, 0.01, 0.05, 1.0], "dev_mode": True})
        assert self.compare_dict([], res, {"window": "90 days", "var": {"2022-02-17": {"1 day": {"0.0": -486.3783495954481, "0.01": -330.29126030375244, "0.05": -204.0482857757802, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -565.7166893676397, "0.05": -318.3726778585236, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -753.6112121175156, "0.05": -586.3506513599273, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -846.2768686059874, "0.05": -775.3659324527679, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -862.1563537876472, "0.05": -762.8946317815366, "1.0": 909.8273233405478}}, "2022-02-16": {"1 day": {"0.0": -486.3783495954481, "0.01": -330.29126030375244, "0.05": -204.0482857757802, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -565.7166893676397, "0.05": -318.3726778585236, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -753.6112121175156, "0.05": -586.3506513599273, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -846.2768686059874, "0.05": -775.3659324527679, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -862.1563537876472, "0.05": -762.8946317815366, "1.0": 909.8273233405478}}, "2022-02-15": {"1 day": {"0.0": -486.3783495954481, "0.01": -330.29126030375244, "0.05": -204.0482857757802, "1.0": 345.7784766751957}, "2 day": {"0.0": -636.9788353969012, "0.01": -565.7166893676397, "0.05": -318.3726778585236, "1.0": 394.1893424185033}, "5 day": {"0.0": -784.9271476669602, "0.01": -753.6112121175156, "0.05": -586.3506513599273, "1.0": 555.733826796576}, "10 day": {"0.0": -889.1201206652102, "0.01": -846.2768686059874, "0.05": -775.3659324527679, "1.0": 824.6531925945478}, "12 days": {"0.0": -865.1494257601004, "0.01": -862.1563537876472, "0.05": -762.8946317815366, "1.0": 909.8273233405478}}, "2022-02-14": {"1 day": {"0.0": -450.35453904365636, "0.01": -305.8281035904828, "0.05": -188.93536638634083, "1.0": 320.16825297384247}, "2 day": {"0.0": -589.8007385286403, "0.01": -523.8166523682186, "0.05": -294.7922758081824, "1.0": 364.9935482294101}, "5 day": {"0.0": -726.7911987949929, "0.01": -697.794690766168, "0.05": -542.9223515618818, "1.0": 514.5731745792358}, "10 day": {"0.0": -823.2670768130922, "0.01": -783.5970276665562, "0.05": -717.938138879669, "1.0": 763.5749180256539}, "12 days": {"0.0": -801.0717811887579, "0.01": -798.3003923109432, "0.05": -706.3905301718826, "1.0": 842.4405920887864}}, "2022-02-13": {"1 day": {"0.0": -442.7277947325278, "0.01": -300.6489113163357, "0.05": -190.27510931804096, "1.0": 314.7462105821802}, "2 day": {"0.0": -579.8124758660169, "0.01": -514.9458287677563, "0.05": -289.79997503719636, "1.0": 358.81239043877565}, "5 day": {"0.0": -714.4830056710623, "0.01": -685.9775528742354, "0.05": -533.7279733616484, "1.0": 505.85888907383065}, "10 day": {"0.0": -809.3250667959243, "0.01": -770.3268290677721, "0.05": -705.7798721326075, "1.0": 750.643793417608}, "12 days": {"0.0": -787.5056480196309, "0.01": -784.7811925521083, "0.05": -694.4278219268099, "1.0": 828.173879007975}}, "2022-02-12": {"1 day": {"0.0": -447.2292655630582, "0.01": -303.705783553912, "0.05": -192.20974695444374, "1.0": 317.94641825563707}, "2 day": {"0.0": -585.707766331946, "0.01": -520.1815823280265, "0.05": -292.7465398335325, "1.0": 362.4606445768942}, "5 day": {"0.0": -721.747569692576, "0.01": -692.952285387986, "0.05": -539.1546959033789, "1.0": 511.00225043632673}, "10 day": {"0.0": -817.553945181118, "0.01": -778.1591897017336, "0.05": -712.9559463366222, "1.0": 758.276025187085}, "12 days": {"0.0": -795.5126756912955, "0.01": -792.7605191014081, "0.05": -701.4884732378505, "1.0": 836.5944042230542}}, "2022-02-11": {"1 day": {"0.0": -449.24937318822055, "0.01": -305.0776042651321, "0.05": -193.07794679142074, "1.0": 319.38256305511175}, "2 day": {"0.0": -588.3533729949946, "0.01": -522.5312111690793, "0.05": -294.06885830169676, "1.0": 364.09785745250775}, "5 day": {"0.0": -725.0076599443682,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "0.01": -696.0823090768952, "0.05": -541.5900251543957, "1.0": 513.3104167887274}, "10 day": {"0.0": -821.246787053983, "0.01": -781.6740878395544, "0.05": -716.1763253558399, "1.0": 761.701112269724}, "12 days": {"0.0": -799.1059584789368, "0.01": -796.3413705636847, "0.05": -704.6570543725558, "1.0": 840.3732507012948}}, "2022-02-10": {"1 day": {"0.0": -474.2705884942374, "0.01": -322.0690857828225, "0.05": -203.83153970848366, "1.0": 337.170767896616}, "2 day": {"0.0": -621.1220696261222, "0.01": -551.633902723192, "0.05": -308.4922539108651, "1.0": 384.37650763542473}, "5 day": {"0.0": -765.3873996627344, "0.01": -734.8510339000801, "0.05": -571.7542088700216, "1.0": 541.8995506280104}, "10 day": {"0.0": -866.9866231107894, "0.01": -825.2098985011611, "0.05": -756.0641985578193, "1.0": 804.124515987971}, "12 days": {"0.0": -843.6126477092976, "0.01": -840.6940843995579, "0.05": -743.9033548164127, "1.0": 887.1783467084175}}, "2022-02-09": {"1 day": {"0.0": -498.33948857417175, "0.01": -338.4138662364322, "0.05": -214.1758475390804, "1.0": 354.2819481368745}, "2 day": {"0.0": -652.6435794855826, "0.01": -579.6289367975222, "0.05": -324.1480196592498, "1.0": 403.8833460938748}, "5 day": {"0.0": -804.2302739455595, "0.01": -772.1442090150122, "0.05": -600.7703343845001, "1.0": 569.4005731536469}, "10 day": {"0.0": -910.9855868005794, "0.01": -867.0887226868581, "0.05": -794.4339269166439, "1.0": 844.9332717840838}, "12 days": {"0.0": -886.4253985238689, "0.01": -883.3587201709804, "0.05": -781.6559288755603, "1.0": 932.2020262239473}}, "2022-02-08": {"1 day": {"0.0": -478.9522081374349, "0.01": -325.2482940134123, "0.05": -205.8436015216189, "1.0": 340.49904784563915}, "2 day": {"0.0": -627.2532895510543, "0.01": -557.0791910828223, "0.05": -311.5374425241179, "1.0": 388.1707648636515}, "5 day": {"0.0": -772.9426914557451, "0.01": -742.1048951316045, "0.05": -577.3981087876299, "1.0": 547.2487492551371}, "10 day": {"0.0": -875.5448211176099, "0.01": -833.3557101207467, "0.05": -763.5274591718173, "1.0": 812.0621895881371}, "12 days": {"0.0": -851.9401165394961, "0.01": -848.9927435087823, "0.05": -751.2465733145409, "1.0": 895.935861249128}}, "2022-02-07": {"1 day": {"0.0": -485.84863112308716, "0.01": -329.9315375036159, "0.05": -208.80753930260056, "1.0": 345.40188662633346}, "2 day": {"0.0": -636.2850967551764, "0.01": -565.1005628876469, "0.05": -316.0232637459676, "1.0": 393.7600277163572}, "5 day": {"0.0": -784.07227735885, "0.01": -752.7904482402396, "0.05": -585.7120522702176, "1.0": 555.1285727304464}, "10 day": {"0.0": -888.1517729736323, "0.01": -845.3551818359958, "0.05": -774.5214753390801, "1.0": 823.7550563395683}, "12 days": {"0.0": -864.2071847402054, "0.01": -861.2173725458946, "0.05": -762.0637572591492, "1.0": 897.8766396336057}}, "2022-02-06": {"1 day": {"0.0": -468.93930915624446, "0.01": -318.4487047090316, "0.05": -201.5402678007543, "1.0": 333.380628697874}, "2 day": {"0.0": -614.1400316577075, "0.01": -545.432981774116, "0.05": -305.0244901087126, "1.0": 380.0557283527104}, "5 day": {"0.0": -756.7836740082778, "0.01": -726.590567768346, "0.05": -565.3271154045866, "1.0": 461.9559070294484}, "10 day": {"0.0": -857.2408198030581, "0.01": -815.933707676522, "0.05": -747.5652750787883, "1.0": 795.0853461105576}, "12 days": {"0.0": -834.1295914390756, "0.01": -831.2438357219789, "0.05": -735.5411314755391, "1.0": 747.8732144876094}}, "2022-02-05": {"1 day": {"0.0": -463.10570400562597, "0.01": -314.48720272417785, "0.05": -199.03310680711752, "1.0": 329.23337357399106}, "2 day": {"0.0": -606.5001294743618, "0.01": -538.6477953125252, "0.05": -301.2299853576296, "1.0": 375.32783497471735}, "5 day": {"0.0": -747.3692848700712, "0.01": -717.5517808810816, "0.05": -558.2944459144934, "1.0": 456.2091754034423}, "10 day": {"0.0": -846.5767437401632, "0.01": -805.7834921012286, "0.05": -738.2655628261093, "1.0": 674.7456538275146}, "12 days": {"0.0": -823.7530190641609, "0.01": -820.9031621490753, "0.05": -726.3909995729952, "1.0": 713.7552293740246}}}})
